#!/usr/bin/env perl

use strict;
use warnings;
use Fatal qw(open close);

use Test::More;

my $smc = 'bin/smc';
#my $smc = 'java -jar Smc.jar';
my $test_graph = 1;
my $test_table = 0;

sub slurp {
    my ($filename) = @_;
    local $/;
    undef $/;
    open my $fh, '<', $filename;
    read $fh, my $text, 4096;
    close $fh;
    return $text;
}

sub spew {
    my ($filename, $text) = @_;
    open my $fh, '>', $filename;
    print {$fh} $text;
    close $fh;
}

sub run {
    my $cmd = join ' ', @_;
    return qx{$cmd};
}

sub do_fsm {
    my ($lang, $fsm) = @_;
    my $sm = slurp("t/templates/${fsm}.sm");
    spew("t/${lang}/TestClass.sm", $sm);
}

sub test_smc_graph {
    my ($lang, $test, $level) = @_;
    unlink("t/${lang}/TestClass.sm");
    unlink("t/${lang}/TestClassContext.dot");
    unlink("t/${lang}/TestClassContext${level}.png");
    do_fsm($lang, $test);
    system("${smc} -graph -glevel ${level} t/${lang}/TestClass.sm");
    system("dot -T png -o t/${lang}/TestClassContext${level}.png t/${lang}/TestClassContext.dot");
}

sub test_smc_table {
    my ($lang, $test) = @_;
    unlink("t/${lang}/TestClass.sm");
    unlink("t/${lang}/TestClassContext.html");
    do_fsm($lang, $test);
    system("${smc} -table t/${lang}/TestClass.sm");
}

sub test_smc {
    my ($lang, $test, $options) = @_;
    unlink("t/${lang}/TestClass.sm");
    unlink("t/${lang}/TestClassContext.${lang}");
    do_fsm($lang, $test);
    system("${smc} -${lang} ${options} t/${lang}/TestClass.sm");
    my $out = run($lang, "t/${lang}/${test}.${lang}");
    my $expected = slurp("t/templates/${test}.out");
    is($out, $expected, "$test $options");
}

sub test_smc_with_options {
    my ($lang, $test, $options) = @_;
    for my $option (@{$options}) {
        test_smc($lang, $test, $option);
    }
    if ($test_graph) {
        for my $level (0..2) {
            test_smc_graph($lang, $test, $level);
        }
    }
    if ($test_table) {
        test_smc_table($lang, $test) if ($test_table);
    }
}

my @tests = qw(
    Simple
    EntryExit
    Guard
    Default
    Map
);

#@tests = ( 'Simple' );

my @opt = (
    '',
    '-g0',
    '-g1',
    '-noc',
    '-noc -g0',
    '-noc -g1',
    '-reflect',
);

plan tests => scalar(@tests) * scalar(@opt);

for my $test (@tests) {
    test_smc_with_options('lua', $test, \@opt);
}

